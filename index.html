<!DOCTYPE html><html lang="en"><head>
	<!-- Replace "latest" by the specific version you want to use, e.g. "4.0.0" -->
	<script src="https://cdn.jsdelivr.net/npm/molstar@5.2.0/build/viewer/molstar.js"></script>
	<!-- Replace "latest" by the specific version you want to use, e.g. "4.0.0" -->
	<!--link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/molstar@5.2.0/build/viewer/molstar.css" /-->

</head>
<body>
  <div id="div0"></div>

  <link rel="stylesheet" href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/jquery-ui-1.13.2.min.css">
  <link rel="stylesheet" href="https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.css">
  <script src="https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/jquery-3.5.0.min.js"></script>
  <script src="https://www.ncbi.nlm.nih.gov/Structure/icn3d/lib/jquery-ui-1.13.2.min.js"></script>

  <!--script src="icn3d.min.js"></script-->

  <script type="module">
    import * as icn3d from './icn3d.module.js';

    // add new classes
    //import {icn3d2molstar} from './icn3d2molstar.js';

    //$( document ).ready(function() {
      if (navigator.userAgent.indexOf("MSIE ") > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) { // If Internet Explorer
          $.getScript('icn3d_full_ui_2.24.7.min.js', function() {
            var version = 2;
            launchIcn3d(version);
          });
          alert("iCn3D version 3 (since May 2021) works in all browsers except IE. The old iCn3D version 2 is used instead.");
      }
      else {
          //$.getScript('icn3d.min.js', function() {
            var version = 3;
            launchIcn3d(version);
          //});
      }

    //Render the scene and objects into pixels.
    icn3d.Draw.prototype.render = function(bVrAr) { let ic = this.icn3d, me = ic.icn3dui;
        let thisClass = this;
/*
        // setAnimationLoop is required for VR
        if(bVrAr) {
            ic.renderer.setAnimationLoop( function() {
                thisClass.render_base();
            });
        }
        else {
            thisClass.render_base();
        }
*/
          $("#" + ic.pre + "title").css("color", "black");
          $("#" + ic.pre + "titlelink").css("color", "black");

//        await icn3d2molstar(me, ic.inputid);
//    }

//	async function icn3d2molstar(icn3dui, pdbid) {

		let icn3dui = me;
		let pdbid = ic.inputid;

		let style2colorSelArray = getStyleColorSel(icn3dui);

		// doc: https://molstar.org/mol-view-spec-docs/
		// examples: https://molstar.org/mol-view-spec/
		// many examples: https://molstar.org/mol-view-stories/builder/?template=mvs-features

		// Build an ad-hoc MVS view
		const builder = molstar.PluginExtensions.mvs.MVSData.createBuilder();
		const structure = builder
			.download({ url: 'https://www.ebi.ac.uk/pdbe/entry-files/' + pdbid.toLowerCase() + '.bcif' })
			.parse({ format: 'bcif' })
			.modelStructure({});

		style2colorSelArray.forEach((style2colorSel, index) => {
			for(let style in style2colorSel) {
				let sel = style2colorSel[style]['sel'];

				let rep = structure
					.component({ selector: style2colorSel[style]['sel'] })
					.representation({ type: style });

				for(let i = 0, il = style2colorSel[style]['color'].length; i < il; ++i) {
					rep.color(style2colorSel[style]['color'][i]);
				}
			}
		});

	   let lines = ic.lines;

       if(lines !== undefined) {
         for(let name in lines) {
             let lineArray = lines[name];

             for(let i = 0, il = lineArray.length; i < il; ++i) {
               let line = lineArray[i];

               let p1 = line.position1;
               let p2 = line.position2;

               let dashed = (line.dashed) ? line.dashed : false;
               let dashSize = (name == 'missingres') ? 0.8 : 0.3;

               let radius = (line.radius) ? line.radius : ic.lineRadius;
               let opacity = (line.opacity) ? line.opacity : 1.0;

               let colorStr = line.color.replace(/\#/g, '');
               if(colorStr.length == 3) colorStr = colorStr[0] + colorStr[0] + colorStr[1] + colorStr[1] + colorStr[2] + colorStr[2];
               colorStr = '#' + colorStr;

			   structure
				  .primitives({ opacity: opacity, ref: 'prim_lines' })
				  .lines({
				    vertices: [p1.x, p1.y, p1.z, p2.x, p2.y, p2.z],
				    indices: [0, 1],
				    color: colorStr,
				    //dash_length: 0.25,
				    width: 1 //radius
  				  });
             }
         }
       }

		const mvsData = builder.getState();

		console.log(JSON.stringify(mvsData));

		// Initialize viewer and load MVSJ
		//molstar.Viewer
		//	.create('div0_viewer', { layoutIsExpanded: false, layoutShowControls: false })
		//	.then(viewer => molstar.PluginExtensions.mvs.loadMVS(viewer.plugin, mvsData, { sourceUrl: undefined, sanityChecks: true, replaceExisting: false }));

		if (!ic.molstarViewer) {
			ic.molstarViewer = molstar.Viewer
					.create('div0_viewer', { layoutIsExpanded: false, layoutShowControls: false })
		}

		// Initialize viewer and load MVSJ
		ic.molstarViewer.then(viewer => molstar.PluginExtensions.mvs.loadMVS(viewer.plugin, mvsData, { sourceUrl: undefined, sanityChecks: true, replaceExisting: true }));
	}

	function getStyleColorSel(icn3dui) {
		let ic = icn3dui.icn3d;

		let style2colorSelArray = [];

		for(let oriStyle in ic.style2atoms) { // different icn3d style may convert to the same molstar style
			let style2colorSel = {};

			let atomHash = ic.style2atoms[oriStyle];
			let style = convertStyle(oriStyle);

			if(!style) continue;

			style2colorSel[style] = {};

			let residueArray = ic.resid2specCls.atoms2residues(Object.keys(atomHash));

			let selector = residueids2selector(icn3dui, residueArray);

			style2colorSel[style]['sel'] = selector;
console.log("style: " + oriStyle + " selector " + JSON.stringify(selector))
			let colorArray = [], color2atoms = {};

			for(let i in atomHash) {
				let color = '#' + ic.atoms[i].color.getHexString();
				if(!color2atoms[color]) color2atoms[color] = {};
				color2atoms[color][i] = 1;
			}

			for(let color in color2atoms) {
				let colorAtomHash = color2atoms[color];
				let colorResidueArray = ic.resid2specCls.atoms2residues(Object.keys(colorAtomHash));
				let colorSelector = residueids2selector(icn3dui, colorResidueArray);
console.log("color: " + color + " color selector " + JSON.stringify(colorSelector))
				let colorFull = {selector: colorSelector, color: color};
				colorArray.push(colorFull);
			}

			style2colorSel[style]['color'] = colorArray;

			style2colorSelArray.push(style2colorSel);
		}

		return style2colorSelArray;
	}

	function convertStyle(styleName) {
		let molStyle = '';

		//iCn3D styles:
		//protein: ribbon, strand, cylinder and plate, schematic, c alpha trace, backbone, b factor tube, lines, stick, ball and stick, sphere, nothing
		//nucleotide: nucleotide cartoon, o3 trace, backbone, schematic, lines, stick, ball and stick, sphere, nothing

		//MolStar styles:
		//cartoon | ball_and_stick | spacefill | carbohydrate | surface
		if(styleName == 'ribbon' || styleName == 'strand' || styleName == 'cylinder and plate' || styleName == 'nucleotide cartoon') {
			molStyle = 'cartoon';
		}
		else if(styleName == 'c alpha trace' || styleName == 'o3 trace' || styleName == 'schematic' || styleName == 'b factor tube') {
			molStyle = 'backbone';
		}
		else if(styleName == 'lines') {
			molStyle = 'line';
		}
		else if(styleName == 'ball and stick' || styleName == 'backbone' || styleName == 'stick') {
			molStyle = 'ball_and_stick';
		}
		else if(styleName == 'sphere') {
			molStyle = 'spacefill';
		}
		else {
			molStyle = '';
		}

		return molStyle;
	}

    function residueids2selector(icn3dui, residueArray) {
    	 let ic = icn3dui.icn3d;
         let selArray = [];

         if(residueArray !== undefined){
             let residueArraySorted = residueArray.sort(function(a, b) {
                if(a !== '' && !isNaN(a)) {
                    return parseInt(a) - parseInt(b);
                }
                else {
                    let lastPosA = a.lastIndexOf('_');
                    let lastPosB = b.lastIndexOf('_');
                    if(a.substr(0, lastPosA) < b.substr(0, lastPosB)) return -1;
                    else if(a.substr(0, lastPosA) > b.substr(0, lastPosB)) return 1;
                    else if(a.substr(0, lastPosA) == b.substr(0, lastPosB)) {
                        if(parseInt(a.substr(lastPosA + 1)) < parseInt(b.substr(lastPosB + 1)) ) return -1;
                        else if(parseInt(a.substr(lastPosA + 1)) > parseInt(b.substr(lastPosB + 1)) ) return 1;
                        else if(parseInt(a.substr(lastPosA + 1)) == parseInt(b.substr(lastPosB + 1)) ) return 0;
                    }
                }
             });
             let prevChain = '', chain, prevResi = 0, resi, lastDashPos, firstDashPos, struturePart, chainPart;
             let startResi;
             let bMultipleStructures =(Object.keys(ic.structures).length == 1) ? false : true;

             for(let j = 0, jl = residueArraySorted.length; j < jl; ++j) {
                 let residueid = residueArraySorted[j];
                 lastDashPos = residueid.lastIndexOf('_');
                 chain = residueid.substr(0, lastDashPos);
                 // allow resi such as 35A
                 //resi = parseInt(residueid.substr(lastDashPos+1));
                 resi = residueid.substr(lastDashPos+1);
                 firstDashPos = prevChain.indexOf('_');
                 struturePart = prevChain.substr(0, firstDashPos);
                 chainPart = prevChain.substr(firstDashPos + 1);

                 // create separate spec for resi such as 100a
                 if(isNaN(resi)) {
                 	let resiNCBI = ic.ParserUtilsCls.getResiNCBI(chain, resi);
                    if(bMultipleStructures) {
                    	selArray.push(getSelector(struturePart, chainPart, true, resiNCBI, undefined, true));
                    }
                    else {
                    	selArray.push(getSelector(undefined, chainPart, true, resiNCBI, undefined, true));
                    }

                    continue;
                 }

                 if(prevChain !== chain) {
                     if(j > 0) {
                         if(prevResi === startResi) {
                             if(bMultipleStructures) {
                             	 selArray.push(getSelector(struturePart, chainPart, true, startResi));
                             }
                             else {
                             	 selArray.push(getSelector(undefined, chainPart, true, startResi));
                             }
                         }
                         else {
                             if(bMultipleStructures) {
                                 selArray.push(getSelector(struturePart, chainPart, false, startResi, prevResi));
                             }
                             else {
                             	 selArray.push(getSelector(undefined, chainPart, false, startResi, prevResi));
                             }
                         }
                     }
                     startResi = resi;
                 }
                 else if(prevChain === chain) {
                     // some residue number could be "35A"
                     //let tmpPrevResi = !isNaN(prevResi) ? parseInt(prevResi) : prevResi;
                     let tmpPrevResi = ic.ParserUtilsCls.getResiNCBI(prevChain, prevResi);
                     //if(resi != parseInt(prevResi) + 1) {
                     //if(resi != tmpPrevResi + 1) {
                     if(ic.ParserUtilsCls.getResiNCBI(chain, resi) != tmpPrevResi + 1) {
                         if(prevResi === startResi) {
                             if(bMultipleStructures) {
                                 selArray.push(getSelector(struturePart, chainPart, true, startResi));
                             }
                             else {
                                 selArray.push(getSelector(undefined, chainPart, true, startResi));
                             }
                         }
                         else {
                             if(bMultipleStructures) {
                                 selArray.push(getSelector(struturePart, chainPart, false, startResi, prevResi));
                             }
                             else {
                                 selArray.push(getSelector(undefined, chainPart, false, startResi, prevResi));
                             }
                         }
                         startResi = resi;
                     }
                 }
                 prevChain = chain;
                 prevResi = resi;
             }



             // last residue
             firstDashPos = prevChain.indexOf('_');
             struturePart = prevChain.substr(0, firstDashPos);
             chainPart = prevChain.substr(firstDashPos + 1);
			 if(prevResi === startResi) {
				 if(bMultipleStructures) {
					 selArray.push(getSelector(struturePart, chainPart, true, startResi));
				 }
				 else {
					 selArray.push(getSelector(undefined, chainPart, true, startResi));
				 }
			 }
			 else {
				 if(bMultipleStructures) {
					 selArray.push(getSelector(struturePart, chainPart, false, startResi, prevResi));
				 }
				 else {
					 selArray.push(getSelector(undefined, chainPart, false, startResi, prevResi));
				 }
			 }
         }

         return selArray;
    }

    function getSelector(struct, chain, bResiAlone, resi1, resi2, bNCBI) {
    	let selector = {};

    	if(struct) selector['label_entity_id'] = struct;
    	selector['auth_asym_id'] = chain;

    	if(bResiAlone) {
    		if(bNCBI) {
    			selector['label_seq_id'] = parseInt(resi1);
    		}
    		else {
    			selector['auth_seq_id'] = parseInt(resi1);
    		}
    	}
    	else {
    		if(bNCBI) {
				selector['beg_label_seq_id'] = parseInt(resi1);
				selector['end_label_seq_id'] = parseInt(resi2);
    		}
    		else {
				selector['beg_auth_seq_id'] = parseInt(resi1);
				selector['end_auth_seq_id'] = parseInt(resi2);
			}
		}

		return selector;
    }

      async function launchIcn3d(version) {
          var cfg_params = getConfig();
          var cfg = cfg_params.cfg;
          var params = (cfg_params.params) ? cfg_params.params : {};
          params.version = version;

          if(params.mmtfid !== undefined) {
              await setupViewer('mmtfid', params.mmtfid, cfg, params);
          }
          else if(params.pdbid !== undefined) {
              await setupViewer('pdbid', params.pdbid, cfg, params);
          }
          else if(params.opmid !== undefined) {
              await setupViewer('opmid', params.opmid, cfg, params);
          }
          else if(params.cid !== undefined) {
              await setupViewer('cid', params.cid, cfg, params);
          }
          else if(params.mmcifid !== undefined) {
              await setupViewer('mmcifid', params.mmcifid, cfg, params);
          }
          else if(params.mmdbid !== undefined) {
              await setupViewer('mmdbid', params.mmdbid, cfg, params);
          }
          else if(params.gi !== undefined) {
              await setupViewer('gi', params.gi, cfg, params);
          }
          else if(params.blast_rep_id !== undefined) {
              if( (params.from === 'blast' || params.from === 'icn3d') && params.command == '') {
                command = 'view+annotations;+set+annotation+cdd;+set+annotation+site;+set+view+detailed+view;+select+chain+'
                  + params.blast_rep_id + ';+show+selection';
              }

              await setupViewer('blast_rep_id', params.blast_rep_id, cfg, params);
          }
          else if(params.urlname !== undefined) {
              var urlname = decodeURIComponent(params.urlname);

              await setupViewer('url', params.urltype + '|' + urlname, cfg, params);
          }
          // e.g., align=103701,1,4,68563,1,167 [mmdbid1,biounit,molecule,mmdbid2,biounit,molecule]
          else if(params.align !== undefined) {
              cfg.divid = 'div0';
              cfg.align = params.align;
              cfg.showalignseq = params.showalignseq;

              var icn3dui = (params.version == 2) ? new iCn3DUI(cfg) : new icn3d.iCn3DUI(cfg);

              await icn3dui.show3DStructure();
          }
          else if(params.chainalign !== undefined) {
              cfg.divid = 'div0';
              cfg.chainalign = params.chainalign;
              cfg.resnum = params.resnum;
              cfg.showalignseq = params.showalignseq;

              var icn3dui = (params.version == 2) ? new iCn3DUI(cfg) : new icn3d.iCn3DUI(cfg);

              await icn3dui.show3DStructure();
          }
          else if(params.mmdbafid !== undefined) {
              cfg.divid = 'div0';

              var icn3dui = (params.version == 2) ? new iCn3DUI(cfg) : new icn3d.iCn3DUI(cfg);

              await icn3dui.show3DStructure();
          }
          else {
              await setupViewer('', '', cfg, params);
          }
      }

      async function setupViewer(idName, idValue, cfg, params) {
        var maxStructure = 5; // show max 5 structures

        var idArray = idValue.replace(/\s/g, '').split(',');

        if(idArray.length > 1) {
          resize = false;

          if(cfg.width && cfg.width.indexOf('%') != -1) {
            cfg.width = 400;
            cfg.height = 400;
          }
        }

        if(cfg.options === undefined || cfg.options === 'undefined') cfg.options = {};

        //Options are available at: https://www.ncbi.nlm.nih.gov/Structure/icn3d/icn3d.html#DisplayOptions
        //cfg.options['chemicalbinding'] = 'show';

        for(var i = 0, il = idArray.length; i < il && i < maxStructure; ++i) {
          cfg.divid = 'div' + i;

          if(params) {
              cfg.blast_rep_id = params.blast_rep_id;
              cfg.query_id = params.query_id;
              cfg.rid = params.rid;
          }

          if(idName !== '') cfg[idName] = idArray[i];

          var icn3dui = (params.version == 2) ? new iCn3DUI(cfg) : new icn3d.iCn3DUI(cfg);

          await icn3dui.show3DStructure();

          if(idName === '') $("#div" + i + "_wait").hide();

          //await icn3d2molstar(icn3dui, idValue);
        }
      }

      function getConfig() {
        // separating the GET parameters from the current URL
        // repalce "color #" with "color " in the url
        var url = document.URL.replace(/\#/g, '');

        var bNopara = false;
        var ampPos = url.indexOf("?");
        if(ampPos === -1) {
        //  alert("Please include '?pdbid=1GPK,2POR,...' in your url");
            bNopara = true;
        }

        var getParams = url.split("?");
        // transforming the GET parameters into a dictionnary
        var search = getParams[getParams.length - 1];
        var params = {};
        var inpara = "";

        var command;
        if(!bNopara) {
            var decodeSearch = decodeURIComponent(search);

            // command could contains '&', for example when loading statefile 'load mmdb 1kq2 | parameters &atype=1'
            var commandPos = decodeSearch.indexOf('&command=');
            if(commandPos != -1) {
                command = decodeSearch.substr(commandPos + 9); // ";" separated commands
                decodeSearch = decodeSearch.substr(0, commandPos);

                var paraPos = decodeSearch.indexOf(' | parameters ');

                if(paraPos != -1) { //When loading statefile (e.g., 'load mmdb 1kq2 | parameters &atype=1'), the commands ends with '}}'.
                    //var tmpPos = command.indexOf('}}&');
                    var tmpPos = command.indexOf(';');
                    if(tmpPos != -1) { // more parameters after the command
                      decodeSearch += command.substr(tmpPos + 2);
                      command = command.substr(0, tmpPos + 2);
                    }
                }
                else {
                    var tmpPos = command.indexOf('&');
                    if(tmpPos != -1) {
                      decodeSearch += command.substr(tmpPos);
                      command = command.substr(0, tmpPos);
                    }
                }
            }
            else {
                command = '';
            }

            var hashes = decodeSearch.split('&');
            for (var i = 0; i < hashes.length; i++) {
                var hash = hashes[i].split('=');
                params[hash[0].trim()] = (hash[1] !== undefined) ? hash[1].trim() : undefined;
            }

            // for mmdb structures, pass the parameters after the first "&" sign
            inpara = "&" + url.substr(ampPos + 1);
        }

        var gi = params.gi;
        var blast_rep_id = params.blast_rep_id;
        var query_id = params.query_id;
        var rid = params.RID;

        var mmdbid = params.mmdbid;
        var mmtfid = params.mmtfid;
        var pdbid = params.pdbid;
        var opmid = params.opmid;
        var cid = params.cid;
        var mmcifid = params.mmcifid;
        var urlname = params.url;
        if(urlname && urlname.indexOf('%3A%2F%2F') === -1) { // decoded URL
            // should encode it
            urlname = encodeURIComponent(urlname);
        }
        var urltype = (params.type === undefined) ? 'pdb' : params.type;

        var align = params.align;
        var chainalign = params.chainalign;
        var resnum = params.resnum;

        var width = params.width;
        var height = params.height;

        var from = params.from;

        var date = getValue(params.date);
        var version = getValue(params.v);

        if(version !== undefined && window.localStorage && localStorage.getItem('fixedversion')) {
            //var version = getVersion(date);
            var fixedUrl = url.replace('full.html', 'full_' + version + '.html');
            window.open(fixedUrl, '_self');

            localStorage.removeItem('fixedversion');
        }

        // use PDB residue number in MMDB input
        var usepdbnum = getValue(params.usepdbnum);
        //if(usepdbnum === undefined) usepdbnum = (date !== undefined && date >= '20201222') ? true : false;

        var resize = getValue(params.resize);

        var showmenu = getValue(params.showmenu);

        var showtitle = getValue(params.showtitle);

        var showcommand = getValue(params.showcommand);

        //var simplemenu = getValue(params.simplemenu);

        var mobilemenu = getValue(params.mobilemenu);

        var imageonly = getValue(params.imageonly);

        var closepopup = getValue(params.closepopup);

        var showanno = getValue(params.showanno);

        var showseq = getValue(params.showseq);

        // backward compatible with showseq
        showanno = showanno || showseq;

        // for alignment
        var showalignseq = getValue(params.showalignseq);

        var show2d = getValue(params.show2d);

        var showsets = getValue(params.showsets);

        var replay = getValue(params.replay);

        var notebook = getValue(params.notebook);

        var rotate = params.rotate;

        var shownote = 1; //params.shownote;

        var options = (params.options !== undefined) ? JSON.parse(params.options) : undefined;

        var cfg = {
          inpara: inpara,
          width: width,
          height: height,
          resize: resize,
          rotate: rotate,
          showmenu: showmenu,
          showtitle: showtitle,
          showcommand: showcommand,
          showanno: showanno,
          show2d: show2d,
          showsets: showsets,
          //simplemenu: simplemenu,
          mobilemenu: mobilemenu,
          imageonly: imageonly,
          closepopup: closepopup,
          replay: replay,
          notebook: notebook,
          shownote: shownote,
          options: options,
          usepdbnum: usepdbnum,
          date: date,
          command: command
        };

        return {cfg: cfg, params: params};
      }

      function getValue(input) {
        if(input == 'true' || input == '1') {
          input = true;
        }
        else if(input == 'false' || input == '0') {
          input = false;
        }

        return input;
      }
    //}); // document ready
  </script>

  <!-- log & Google Analytics -->
  <script type="text/javascript" src="https://www.ncbi.nlm.nih.gov/core/pinger/pinger.js"></script>
</body></html>

